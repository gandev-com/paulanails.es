---
// Booking Gateway Section - Login & Forgot Password Gateway
// Redirige a app externa para gesti칩n real de autenticaci칩n
import "../../styles/sections/BookingGateway.css";

// 游댢 CONFIGURACI칍N: Modifica estas URLs para tu entorno
const LOGIN_REDIRECT_URL = "https://app.paulanails.es/login";
const FORGOT_REDIRECT_URL = "https://app.paulanails.es/forgot-password";
const PASS_EMAIL_IN_QUERY = true; // true: pasa email por query, false: solo redirige
---

<section id="booking" class="booking-gateway-section">
  <div class="booking-container">
    <!-- Header -->
    <div class="booking-header">
      <p class="booking-eyebrow">츼rea de cliente</p>
      <h2 class="booking-title">Accede a tu cuenta</h2>
      <p class="booking-subtitle">
        Gestiona tus reservas y preferencias de forma segura
      </p>
    </div>

    <!-- Gateway Card -->
    <div class="booking-card">
      <!-- Login View (default) -->
      <div class="booking-view" data-view="login">
        <form class="booking-form" id="loginForm" novalidate>
          <div class="form-group">
            <label for="loginEmail" class="form-label">
              Correo electr칩nico
            </label>
            <input
              type="email"
              id="loginEmail"
              name="email"
              class="form-input"
              placeholder="tu@email.com"
              required
              autocomplete="email"
              aria-describedby="loginEmailError"
            />
            <span class="form-error" id="loginEmailError" role="alert"></span>
          </div>

          <div class="form-group">
            <label for="loginPassword" class="form-label"> Contrase침a </label>
            <input
              type="password"
              id="loginPassword"
              name="password"
              class="form-input"
              placeholder="M칤nimo 8 caracteres"
              required
              minlength="8"
              autocomplete="current-password"
              aria-describedby="loginPasswordError"
            />
            <span class="form-error" id="loginPasswordError" role="alert"
            ></span>
          </div>

          <button type="submit" class="btn-primary">
            <span class="btn-text">Iniciar sesi칩n</span>
            <svg
              class="btn-icon"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M5 12h14"></path>
              <path d="m12 5 7 7-7 7"></path>
            </svg>
          </button>

          <button
            type="button"
            class="link-secondary"
            data-switch-view="forgot"
          >
            쮿as olvidado tu contrase침a?
          </button>
        </form>

        <p class="booking-disclaimer">
          <svg
            class="disclaimer-icon"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4"></path>
            <path d="M12 8h.01"></path>
          </svg>
          Ser치s redirigido a nuestra plataforma segura de reservas
        </p>
      </div>

      <!-- Forgot Password View (hidden by default) -->
      <div class="booking-view" data-view="forgot" hidden>
        <form class="booking-form" id="forgotForm" novalidate>
          <div class="form-group">
            <label for="forgotEmail" class="form-label">
              Correo electr칩nico
            </label>
            <input
              type="email"
              id="forgotEmail"
              name="email"
              class="form-input"
              placeholder="tu@email.com"
              required
              autocomplete="email"
              aria-describedby="forgotEmailError"
            />
            <span class="form-error" id="forgotEmailError" role="alert"></span>
          </div>

          <button type="submit" class="btn-primary">
            <span class="btn-text">Enviar enlace</span>
            <svg
              class="btn-icon"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              aria-hidden="true"
            >
              <path d="M22 2 11 13"></path>
              <path d="m22 2-7 20-4-9-9-4z"></path>
            </svg>
          </button>

          <button type="button" class="link-secondary" data-switch-view="login">
            Volver a iniciar sesi칩n
          </button>
        </form>

        <p class="booking-disclaimer">
          <svg
            class="disclaimer-icon"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4"></path>
            <path d="M12 8h.01"></path>
          </svg>
          Recibir치s un correo con instrucciones para recuperar tu contrase침a
        </p>
      </div>
    </div>

    <!-- Optional: Create account hint (without implementation) -->
    <p class="booking-hint">
      쯇rimera vez aqu칤?
      <a
        href={`${LOGIN_REDIRECT_URL}?action=register`}
        class="booking-hint-link"
      >
        Crea tu cuenta
      </a>
    </p>
  </div>
</section>

<script
  define:vars={{
    LOGIN_REDIRECT_URL,
    FORGOT_REDIRECT_URL,
    PASS_EMAIL_IN_QUERY,
  }}
>
  // Email validation regex
  const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  // Get elements
  const loginForm = document.getElementById("loginForm");
  const forgotForm = document.getElementById("forgotForm");
  const switchButtons = document.querySelectorAll("[data-switch-view]");

  // View switching
  function switchView(targetView) {
    const views = document.querySelectorAll(".booking-view");
    views.forEach((view) => {
      if (view.dataset.view === targetView) {
        view.hidden = false;
        view.querySelector("input")?.focus();
      } else {
        view.hidden = true;
      }
    });
  }

  switchButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      switchView(btn.dataset.switchView);
    });
  });

  // Validation helpers
  function showError(input, message) {
    const errorElement = document.getElementById(input.id + "Error");
    if (errorElement) {
      errorElement.textContent = message;
      input.setAttribute("aria-invalid", "true");
      input.classList.add("input-error");
    }
  }

  function clearError(input) {
    const errorElement = document.getElementById(input.id + "Error");
    if (errorElement) {
      errorElement.textContent = "";
      input.setAttribute("aria-invalid", "false");
      input.classList.remove("input-error");
    }
  }

  function validateEmail(input) {
    const value = input.value.trim();
    if (!value) {
      showError(input, "El correo electr칩nico es obligatorio");
      return false;
    }
    if (!EMAIL_REGEX.test(value)) {
      showError(input, "Introduce un correo electr칩nico v치lido");
      return false;
    }
    clearError(input);
    return true;
  }

  function validatePassword(input) {
    const value = input.value;
    if (!value) {
      showError(input, "La contrase침a es obligatoria");
      return false;
    }
    if (value.length < 8) {
      showError(input, "La contrase침a debe tener al menos 8 caracteres");
      return false;
    }
    clearError(input);
    return true;
  }

  // Real-time validation
  const loginEmail = document.getElementById("loginEmail");
  const loginPassword = document.getElementById("loginPassword");
  const forgotEmail = document.getElementById("forgotEmail");

  if (loginEmail) {
    loginEmail.addEventListener("blur", () => validateEmail(loginEmail));
    loginEmail.addEventListener("input", () => {
      if (loginEmail.classList.contains("input-error")) {
        validateEmail(loginEmail);
      }
    });
  }

  if (loginPassword) {
    loginPassword.addEventListener("blur", () =>
      validatePassword(loginPassword)
    );
    loginPassword.addEventListener("input", () => {
      if (loginPassword.classList.contains("input-error")) {
        validatePassword(loginPassword);
      }
    });
  }

  if (forgotEmail) {
    forgotEmail.addEventListener("blur", () => validateEmail(forgotEmail));
    forgotEmail.addEventListener("input", () => {
      if (forgotEmail.classList.contains("input-error")) {
        validateEmail(forgotEmail);
      }
    });
  }

  // Login form submission
  if (loginForm) {
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const emailValid = validateEmail(loginEmail);
      const passwordValid = validatePassword(loginPassword);

      if (emailValid && passwordValid) {
        const email = loginEmail.value.trim();

        // Build redirect URL
        let redirectUrl = LOGIN_REDIRECT_URL;
        if (PASS_EMAIL_IN_QUERY) {
          const separator = redirectUrl.includes("?") ? "&" : "?";
          redirectUrl += `${separator}email=${encodeURIComponent(email)}`;
        }

        // Redirect to external app
        window.location.href = redirectUrl;
      }
    });
  }

  // Forgot form submission
  if (forgotForm) {
    forgotForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const emailValid = validateEmail(forgotEmail);

      if (emailValid) {
        const email = forgotEmail.value.trim();

        // Build redirect URL
        let redirectUrl = FORGOT_REDIRECT_URL;
        if (PASS_EMAIL_IN_QUERY) {
          const separator = redirectUrl.includes("?") ? "&" : "?";
          redirectUrl += `${separator}email=${encodeURIComponent(email)}`;
        }

        // Redirect to external app
        window.location.href = redirectUrl;
      }
    });
  }
</script>
